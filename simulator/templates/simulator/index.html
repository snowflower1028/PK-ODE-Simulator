<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <title>PK Simulator + Fitting</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script defer src="{% static 'simulator/js/script.js' %}"></script>
  <link rel="stylesheet" href="{% static 'simulator/css/style.css' %}">

</head>
<body> 
  <aside class="sidebar">
    <section class="sidebar-section">
      <h2 class="sidebar-section-title"><i class="bi bi-file-text"></i> ODE Systems</h2>
      <textarea id="ode-input" class="form-control mb-2" rows="6" placeholder="e.g. dCdt = -kel*C"></textarea>
      <div class="d-flex gap-2"> 
        <button id="parse-btn" class="btn btn-sm btn-outline-secondary">üîç Parse</button>
        <button id="show-processed-btn" class="btn btn-sm btn-outline-info">üìÑ Show Processed ODEs</button>
      </div>
    </section>

    <section class="sidebar-section">
      <h2 class="sidebar-section-title"><i class="bi bi-sliders"></i> Value Settings</h2>
      <div class="value-settings-columns">
        <div>
          <h3 class="subsection-title">Initial Values</h3>
          <div id="init-values">
            <div class="placeholder-text">Parse ODEs to set initial values.</div>
          </div>
        </div>
        <div>
          <h3 class="subsection-title">Parameter Values</h3>
          <div id="param-values">
            <div class="placeholder-text">Parse ODEs to set parameters.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="sidebar-section">
      <h2 class="sidebar-section-title"><i class="bi bi-eyedropper"></i> Dosing</h2>
      <form id="dose-form">
        <div class="row"> 
          <div class="col-6 mb-2">
            <label class="form-label">Compartment</label>
            <select id="compartment" name="compartment" class="form-select form-select-sm" required></select>
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Type</label>
            <select id="type" name="type" class="form-select form-select-sm">
              <option value="bolus">IV Bolus</option>
              <option value="infusion">IV Infusion</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Amount</label>
            <input type="number" id="amount" name="amount" class="form-control form-control-sm" step="any">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Start Time</label>
            <input type="number" id="start_time" name="start_time" class="form-control form-control-sm" step="any">
          </div>
        </div>
        <div class="row" id="duration-label" style="display:none;"> <div class="col-6 mb-2">
            <label class="form-label">Infusion Duration</label>
            <input type="number" id="duration" name="duration" class="form-control form-control-sm" step="any">
          </div>
        </div>
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Repeat every (h)</label>
            <input type="number" id="repeat_every" name="repeat_every" class="form-control form-control-sm" step="any">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Repeat until (h)</label>
            <input type="number" id="repeat_until" name="repeat_until" class="form-control form-control-sm" step="any">
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-2">‚ûï Add Dose</button>
      </form>
      <h3 class="subsection-title mt-3">Registered Doses</h3>
      <div id="dose-list" class="table-responsive">
        </div>
    </section>
  </aside>

  <main class="main-content">
    <div class="main-toolbar">
      <div class="simulation-settings-compact">
          <label class="form-label mb-0 me-1" for="sim-start-time" title="Start Time (h)"><i class="bi bi-clock"></i></label>
          <input id="sim-start-time" type="number" class="form-control" value="0" step="0.1" title="Start Time (h)">
          <label class="form-label mb-0 me-1 ms-2" for="sim-end-time" title="End Time (h)"><i class="bi bi-clock-fill"></i></label>
          <input id="sim-end-time" type="number" class="form-control" value="48" step="0.1" title="End Time (h)">

          <button id="sim-options-btn" type="button" class="btn btn-sm btn-outline-secondary ms-3" title="Advanced Settings" data-bs-trigger="focus" tabindex="0">
              <i class="bi bi-gear-fill"></i>
          </button>

          <div class="form-check form-switch ms-2" title="Use log scale for Y-axis">
            <input class="form-check-input" type="checkbox" id="log-scale">
            <label class="form-check-label small" for="log-scale">Log Y</label>
          </div>
      </div>
      <div class="action-buttons">
        <button class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#obsPanel" title="Observed Data">
          <i class="bi bi-file-earmark-arrow-down"></i> Data
        </button>
        <button id="fit-btn" class="btn btn-warning"><i class="bi bi-tools"></i> Fit Parameters</button>
        <button id="simulate-btn" class="btn btn-primary"><i class="bi bi-play-fill"></i> Run Simulation</button>
      </div>
    </div>

    <div class="main-scrollable-area">
      <div class="mb-3">
          <label class="form-label small">Simulate Compartments:</label>
          <div class="d-flex align-items-start">
              <div class="dropdown me-2" style="width:auto;">
                  <button class="btn dropdown-toggle" data-bs-toggle="dropdown" style="min-width: 180px;">
                      Select Compartments
                  </button>
                  <ul class="dropdown-menu" id="sim-compartments-menu">
                  </ul>
              </div>
              <div id="selected-comp-badges" class="form-control selected-badges-container">
                  </div>
            </div>
          <small class="text-muted d-block mt-1">Multiple selections supported</small>
      </div>

      <div class="card"> 
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-graph-up"></i> Simulation Result</h5>
          <div id="plot-placeholder" class="text-center py-5 text-muted">
            <i class="bi bi-graph-up" style="font-size:2rem;"></i><br> Run simulation to see results.
          </div>
          <div id="plot" style="display:none;"></div>
        </div>
      </div>

      <div class="results-grid"> 
        <div class="card"> 
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-card-list"></i> PK Profile Summary</h5>
            <div id="pk-summary-placeholder" class="text-center py-5 text-muted">
              <i class="bi bi-bar-chart-line" style="font-size:2rem;"></i><br> Summary will appear here.
            </div>
            <div id="pk-summary" style="display:none;"></div>
          </div>
        </div>

        <div class="card" id="fit-summary-card" style="display:none;"> 
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-sliders2-vertical"></i> Fitted Parameters</h5>
            <div id="fit-summary"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-box-arrow-down"></i> Exports & Reports</h5>
        <p class="card-text text-muted small">
          Export your simulation results and plots for presentations or further analysis.
        </p>
        <div class="d-flex flex-wrap gap-2">
          <button id="export-profile-btn" class="btn btn-outline-secondary">
            <i class="bi bi-file-earmark-spreadsheet"></i> Export Profile (CSV)
          </button>
          <button id="export-summary-btn" class="btn btn-outline-secondary">
            <i class="bi bi-table"></i> Export Summary (CSV)
          </button>
          <button id="export-plot-btn" class="btn btn-outline-secondary">
            <i class="bi bi-image"></i> Export Plot (PNG)
          </button>
        </div>
      </div>
    </div>
  </main>

  <div class="modal fade" id="processedModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">üìÑ Processed ODEs</h5> <button class="btn-close" data-bs-dismiss="modal"></button> </div> <div class="modal-body" id="modal-body"></div> </div> </div> </div>
  <div class="modal fade" id="fittingSettingsModal" tabindex="-1" aria-labelledby="fittingSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="fittingSettingsModalLabel"><i class="bi bi-tools"></i> Parameter Fitting Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <section id="fit-param-selection-section">
            <h6><i class="bi bi-ui-checks"></i> Select Parameters to Fit</h6>
            <p class="text-muted small">Check the parameters you want to estimate. Current values will be used as initial guesses.</p>
            <div id="modal-param-list" class="mb-3" style="max-height: 200px; overflow-y: auto;">
              </div>
          </section>

          <hr>

          <section id="fit-param-bounds-section">
            <h6><i class="bi bi-arrows-collapse"></i> Set Parameter Bounds (Optional)</h6>
            <p class="text-muted small">Define lower and upper bounds for the selected parameters. Leave blank for no bounds.</p>
            <div id="modal-param-bounds-list" class="mb-3">
              </div>
          </section>
          
          <hr>
          
          <section id="fit-groups-section">
              <h6><i class="bi bi-collection-fill"></i> Define Fitting Groups</h6>
              <p class="text-muted small">Add each experimental group you want to include in the fitting. Each group should consist of a specific dosing schedule and its corresponding observed data.</p>
              
              <div id="fitting-groups-container">
                  </div>
              
              <button type="button" class="btn btn-sm btn-outline-success mt-2" id="add-fitting-group-btn">
                  <i class="bi bi-plus-circle"></i> Add Experimental Group
              </button>
          </section>

          <hr>
          
          <section id="fit-weighting-section">
            <h6><i class="bi bi-distribute-vertical"></i> Weighting Scheme</h6>
            <p class="text-muted small">Select a weighting method to adjust the influence of each data point on the fit. This is useful for balancing errors across a wide range of concentrations.</p>
            
            <div class="form-check">
              <input class="form-check-input" type="radio" name="fitWeighting" id="weightNone" value="none" checked>
              <label class="form-check-label" for="weightNone">
                <strong>No Weighting</strong> (Ordinary Least Squares)
              </label>
            </div>
            
            <div class="form-check">
              <input class="form-check-input" type="radio" name="fitWeighting" id="weight1Y" value="1/Y">
              <label class="form-check-label" for="weight1Y">
                <strong>1/Y</strong> (Relative Error) - Divides residuals by observed concentration.
              </label>
            </div>
            
            <div class="form-check">
              <input class="form-check-input" type="radio" name="fitWeighting" id="weight1Y2" value="1/Y2">
              <label class="form-check-label" for="weight1Y2">
                <strong>1/Y¬≤</strong> - Divides residuals by the square of observed concentration.
              </label>
            </div>
          </section>

          <hr>

          <section id="fit-progress-section" style="display:none;">
            <h6><i class="bi bi-hourglass-split"></i> Fitting Progress</h6>
            <div id="fit-status-modal"> <div class="d-flex justify-content-between align-items-center">
                  <span id="fit-msg-modal">Initializing...</span>
                  <span id="fit-elapsed-modal" class="text-muted small"></span>
              </div>
              <div class="progress mt-1 mb-2" id="fit-progress-bar-modal" style="height: 10px;"> <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <h6><i class="bi bi-body-text"></i> Fitting Log</h6>
              <pre id="fit-console-output-modal" class="bg-dark text-light p-2 rounded small" style="max-height: 200px; overflow-y: auto; font-size: 0.75em; white-space: pre-wrap;"></pre>
              <h6><i class="bi bi-check2-circle"></i> Fitting Result</h6>
              <div id="fit-result-modal" class="mt-2"></div> </div>
          </section>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="start-fitting-btn"><i class="bi bi-play-circle"></i> Start Fitting</button>
        </div>
      </div>
    </div>
  </div>
  <div class="offcanvas offcanvas-end" tabindex="-1" id="obsPanel" aria-labelledby="obsPanelLabel">
      <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="obsPanelLabel">üìÇ Observed Datasets</h5>
          <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
          <input type="file" id="obs-file" class="form-control mb-2" accept=".csv" multiple>
          <ul id="obs-list" class="list-group mb-3">
              </ul>
          <div id="obs-preview" class="table-responsive small" style="max-height:180px;">
              </div>
      </div>
  </div>

  <!-- Popover content for simulation settings -->
  <div id="popover-content-wrapper" class="d-none">
  <div class="popover-form-container">
    <div class="mb-2">
      <label for="popover-sim-steps" class="form-label small"># Time Points</label>
      <input id="popover-sim-steps" type="number" class="form-control form-control-sm" value="200" min="10" max="1000">
    </div>
    <div>
      <label for="popover-sim-threshold" class="form-label small">Threshold</label>
      <input id="popover-sim-threshold" type="number" class="form-control form-control-sm" value="1e-9" step="any">
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
</body>
</html>